<!doctype html>
<html lang="">
<head>
	<meta charset="utf-8"/>
	<title>PyPika - Python Query Builder - Python Programming for Data Science</title>
	<meta name="author" content="Lucas Ho">


	<meta name="description" content="Today, I am going to talk about another SQL topic - PyPika. Okay, What is PyPika? Basically, PyPika is a SQL query builder, which written in Python and doesn't limit the expressiveness of SQL. The advantage of PyPika is a fast, expressive and flexible way to replace handwritten SQL. To help â€¦">


	<link rel="top" href="#" /><link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,300italic,400italic,600italic|Source+Code+Pro' rel='stylesheet' type='text/css'></link>
	<link rel="stylesheet" href=" https://lucashomil.github.io/datascience/theme/css/main.css" type="text/css" />


    <link href=" https://lucashomil.github.io/datascience/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Python Programming for Data Science Atom Feed" />
</head>

<body>

    <div class="container">

	  <header role="banner">
	    <div class="feeds">
	        <a href=" https://lucashomil.github.io/datascience/feeds/all.atom.xml" rel="alternate"><img src=" https://lucashomil.github.io/datascience/theme/images/icons/feed-32px.png" alt="atom feed"/></a>
	    </div>
	      <nav class="pages">
	      </nav>
		<a href=" https://lucashomil.github.io/datascience" class="title">Python Programming for Data Science</a>
      </header>

	  <div class="wrapper">

		  <div role="main" class="content">
	<article class="full">
			
		<h1>PyPika - Python Query Builder</h1>
		
<div class="metadata">
  <time datetime="2019-07-31T11:10:00-04:00" pubdate>Wed 31 July 2019</time>
    <address class="vcard author">
      by <a class="url fn" href=" https://lucashomil.github.io/datascience/author/lucas-ho.html">Lucas Ho</a>
    </address>
  in <a href=" https://lucashomil.github.io/datascience/category/sql.html">SQL</a>
<p class="tags">tagged <a href=" https://lucashomil.github.io/datascience/tag/python.html">python</a>, <a href=" https://lucashomil.github.io/datascience/tag/sqlite3.html">SQLite3</a></p></div>		
		<p>Today, I am going to talk about another SQL topic - PyPika. Okay, What is PyPika?</p>
<p>Basically, PyPika is a SQL query builder, which written in Python and doesn't limit the expressiveness of SQL. The advantage of PyPika is a fast, expressive and flexible way to replace handwritten SQL.</p>
<p>To help you understand PyPika deeply, you can read the docs: http://pypika.readthedocs.io/en/latest/</p>
<p>But today, I am only going to show you some main classes in PyPika are "pypika.Query", "pypika.Table", and "pypika.Field".</p>
<p>Again, we are going to use "sakila" database as an example.</p>
<div class="highlight"><pre><span></span><span class="c1"># Import some statements</span>

<span class="kn">import</span> <span class="nn">sqlite3</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>

<span class="kn">from</span> <span class="nn">pypika</span> <span class="kn">import</span> <span class="n">Query</span><span class="p">,</span> <span class="n">Table</span><span class="p">,</span> <span class="n">Field</span><span class="p">,</span> <span class="n">Order</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="c1"># Connecting SQLite to the Database</span>

<span class="n">connection</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;sakila.db&#39;</span><span class="p">)</span>

<span class="n">connection</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="c1"># Displaying the output as a DataFrame, I hope you still remember this :)</span>

<span class="k">def</span> <span class="nf">sql_to_df</span><span class="p">(</span><span class="n">sql_query</span><span class="p">):</span>

    <span class="c1"># Use pandas to pass sql query</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="n">sql_query</span><span class="p">,</span> <span class="n">con</span> <span class="o">=</span> <span class="n">connection</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span>
</pre></div>


<p>This is how we used to pass SQL query to pandas and display the output as a DataFrame</p>
<div class="highlight"><pre><span></span><span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39; SELECT first_name, last_name, email</span>
<span class="s1">            FROM customer; &#39;&#39;&#39;</span>

<span class="n">sql_to_df</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>


<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>first_name</th>
      <th>last_name</th>
      <th>email</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>MARY</td>
      <td>SMITH</td>
      <td>MARY.SMITH@sakilacustomer.org</td>
    </tr>
    <tr>
      <th>1</th>
      <td>PATRICIA</td>
      <td>JOHNSON</td>
      <td>PATRICIA.JOHNSON@sakilacustomer.org</td>
    </tr>
    <tr>
      <th>2</th>
      <td>LINDA</td>
      <td>WILLIAMS</td>
      <td>LINDA.WILLIAMS@sakilacustomer.org</td>
    </tr>
    <tr>
      <th>3</th>
      <td>BARBARA</td>
      <td>JONES</td>
      <td>BARBARA.JONES@sakilacustomer.org</td>
    </tr>
    <tr>
      <th>4</th>
      <td>ELIZABETH</td>
      <td>BROWN</td>
      <td>ELIZABETH.BROWN@sakilacustomer.org</td>
    </tr>
  </tbody>
</table>
</div>

<p>Let's see how PyPika can do</p>
<h2>Selecting Data</h2>
<h3>Using pypika.Query</h3>
<div class="highlight"><pre><span></span><span class="n">q</span> <span class="o">=</span> <span class="n">Query</span><span class="o">.</span><span class="n">from_</span><span class="p">(</span><span class="s1">&#39;customer&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;customer_id&#39;</span><span class="p">,</span> <span class="s1">&#39;first_name&#39;</span><span class="p">,</span> <span class="s1">&#39;last_name&#39;</span><span class="p">,</span> <span class="s1">&#39;email&#39;</span><span class="p">)</span>

<span class="c1"># To convert the query into raw SQL, it can be cast to a string</span>

<span class="n">query</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>

<span class="n">query</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="s1">&#39;SELECT &quot;customer_id&quot;,&quot;first_name&quot;,&quot;last_name&quot;,&quot;email&quot; FROM &quot;customer&quot;&#39;</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="c1"># Or you can use the Query.get_sql() function</span>

<span class="n">query_alt</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">get_sql</span><span class="p">()</span>

<span class="n">query_alt</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="s1">&#39;SELECT &quot;customer_id&quot;,&quot;first_name&quot;,&quot;last_name&quot;,&quot;email&quot; FROM &quot;customer&quot;&#39;</span>
</pre></div>


<p>We got the same result as the way we used to do with pandas</p>
<div class="highlight"><pre><span></span><span class="n">sql_to_df</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>


<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>customer_id</th>
      <th>first_name</th>
      <th>last_name</th>
      <th>email</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>MARY</td>
      <td>SMITH</td>
      <td>MARY.SMITH@sakilacustomer.org</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>PATRICIA</td>
      <td>JOHNSON</td>
      <td>PATRICIA.JOHNSON@sakilacustomer.org</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>LINDA</td>
      <td>WILLIAMS</td>
      <td>LINDA.WILLIAMS@sakilacustomer.org</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>BARBARA</td>
      <td>JONES</td>
      <td>BARBARA.JONES@sakilacustomer.org</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>ELIZABETH</td>
      <td>BROWN</td>
      <td>ELIZABETH.BROWN@sakilacustomer.org</td>
    </tr>
  </tbody>
</table>
</div>

<h3>Using pypika.Table</h3>
<div class="highlight"><pre><span></span><span class="n">customer</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s1">&#39;customer&#39;</span><span class="p">)</span>

<span class="n">q</span> <span class="o">=</span> <span class="n">Query</span><span class="o">.</span><span class="n">from_</span><span class="p">(</span><span class="n">customer</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">customer</span><span class="o">.</span><span class="n">customer_id</span><span class="p">,</span> <span class="n">customer</span><span class="o">.</span><span class="n">first_name</span><span class="p">,</span> <span class="n">customer</span><span class="o">.</span><span class="n">last_name</span><span class="p">,</span> <span class="n">customer</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>

<span class="n">query_table</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>

<span class="n">query_table</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="s1">&#39;SELECT &quot;customer_id&quot;,&quot;first_name&quot;,&quot;last_name&quot;,&quot;email&quot; FROM &quot;customer&quot;&#39;</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="n">sql_to_df</span><span class="p">(</span><span class="n">query_table</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>


<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>customer_id</th>
      <th>first_name</th>
      <th>last_name</th>
      <th>email</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>MARY</td>
      <td>SMITH</td>
      <td>MARY.SMITH@sakilacustomer.org</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>PATRICIA</td>
      <td>JOHNSON</td>
      <td>PATRICIA.JOHNSON@sakilacustomer.org</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>LINDA</td>
      <td>WILLIAMS</td>
      <td>LINDA.WILLIAMS@sakilacustomer.org</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>BARBARA</td>
      <td>JONES</td>
      <td>BARBARA.JONES@sakilacustomer.org</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>ELIZABETH</td>
      <td>BROWN</td>
      <td>ELIZABETH.BROWN@sakilacustomer.org</td>
    </tr>
  </tbody>
</table>
</div>

<p>Both of the above examples result in the following SQL:</p>
<p>SELECT customer_id, first_name, last_name, email FROM customer</p>
<p>Results can be ordered by using the following syntax:</p>
<div class="highlight"><pre><span></span><span class="n">q</span> <span class="o">=</span> <span class="n">Query</span><span class="o">.</span><span class="n">from_</span><span class="p">(</span><span class="s1">&#39;customer&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">&#39;customer_id&#39;</span><span class="p">,</span> <span class="s1">&#39;first_name&#39;</span><span class="p">,</span>
                                   <span class="s1">&#39;last_name&#39;</span><span class="p">,</span> <span class="s1">&#39;email&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">orderby</span><span class="p">(</span><span class="s1">&#39;customer_id&#39;</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">Order</span><span class="o">.</span><span class="n">desc</span><span class="p">)</span>

<span class="n">query_order</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
</pre></div>


<p>This results in the following SQL:</p>
<p>SELECT "customer_id", "first_name", "last_name", "phone" FROM "customer" ORDER BY "customer_id" DESC</p>
<div class="highlight"><pre><span></span><span class="n">sql_to_df</span><span class="p">(</span><span class="n">query_order</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>


<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>customer_id</th>
      <th>first_name</th>
      <th>last_name</th>
      <th>email</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>599</td>
      <td>AUSTIN</td>
      <td>CINTRON</td>
      <td>AUSTIN.CINTRON@sakilacustomer.org</td>
    </tr>
    <tr>
      <th>1</th>
      <td>598</td>
      <td>WADE</td>
      <td>DELVALLE</td>
      <td>WADE.DELVALLE@sakilacustomer.org</td>
    </tr>
    <tr>
      <th>2</th>
      <td>597</td>
      <td>FREDDIE</td>
      <td>DUGGAN</td>
      <td>FREDDIE.DUGGAN@sakilacustomer.org</td>
    </tr>
    <tr>
      <th>3</th>
      <td>596</td>
      <td>ENRIQUE</td>
      <td>FORSYTHE</td>
      <td>ENRIQUE.FORSYTHE@sakilacustomer.org</td>
    </tr>
    <tr>
      <th>4</th>
      <td>595</td>
      <td>TERRENCE</td>
      <td>GUNDERSON</td>
      <td>TERRENCE.GUNDERSON@sakilacustomer.org</td>
    </tr>
  </tbody>
</table>
</div>

<h2>Arithmetic</h2>
<h3>Using pypika.Field</h3>
<div class="highlight"><pre><span></span><span class="n">q</span> <span class="o">=</span> <span class="n">Query</span><span class="o">.</span><span class="n">from_</span><span class="p">(</span><span class="s1">&#39;payment&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">Field</span><span class="p">(</span><span class="s1">&#39;amount&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="n">Field</span><span class="p">(</span><span class="s1">&#39;rental_id&#39;</span><span class="p">))</span>

<span class="n">query_field</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>

<span class="n">query_field</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="s1">&#39;SELECT &quot;amount&quot;*&quot;rental_id&quot; FROM &quot;payment&quot;&#39;</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="n">sql_to_df</span><span class="p">(</span><span class="n">query_field</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>


<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>"amount"*"rental_id"</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>227.24</td>
    </tr>
    <tr>
      <th>1</th>
      <td>567.27</td>
    </tr>
    <tr>
      <th>2</th>
      <td>7098.15</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1407.78</td>
    </tr>
    <tr>
      <th>4</th>
      <td>14745.24</td>
    </tr>
  </tbody>
</table>
</div>

<h3>Using pypika.Table</h3>
<div class="highlight"><pre><span></span><span class="n">payment</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s1">&#39;payment&#39;</span><span class="p">)</span>

<span class="n">q</span> <span class="o">=</span> <span class="n">Query</span><span class="o">.</span><span class="n">from_</span><span class="p">(</span><span class="n">payment</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">payment</span><span class="o">.</span><span class="n">amount</span> <span class="o">*</span> <span class="n">payment</span><span class="o">.</span><span class="n">rental_id</span><span class="p">)</span>

<span class="n">query_table_field</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>

<span class="n">query_table_field</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="s1">&#39;SELECT &quot;amount&quot;*&quot;rental_id&quot; FROM &quot;payment&quot;&#39;</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="n">sql_to_df</span><span class="p">(</span><span class="n">query_table_field</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>


<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>"amount"*"rental_id"</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>227.24</td>
    </tr>
    <tr>
      <th>1</th>
      <td>567.27</td>
    </tr>
    <tr>
      <th>2</th>
      <td>7098.15</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1407.78</td>
    </tr>
    <tr>
      <th>4</th>
      <td>14745.24</td>
    </tr>
  </tbody>
</table>
</div>

<p>Both of the above examples result in the following SQL:</p>
<p>SELECT amount*rental_id FROM payment</p>
<p>An alias can also be used for fields and expressions</p>
<div class="highlight"><pre><span></span><span class="n">q</span> <span class="o">=</span> <span class="n">Query</span><span class="o">.</span><span class="n">from_</span><span class="p">(</span><span class="n">payment</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">((</span><span class="n">payment</span><span class="o">.</span><span class="n">amount</span> <span class="o">*</span> <span class="n">payment</span><span class="o">.</span><span class="n">rental_id</span><span class="p">)</span><span class="o">.</span><span class="n">as_</span><span class="p">(</span><span class="s1">&#39;profit&#39;</span><span class="p">))</span>

<span class="n">query_field_alias</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>

<span class="n">query_field_alias</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="s1">&#39;SELECT &quot;amount&quot;*&quot;rental_id&quot; &quot;profit&quot; FROM &quot;payment&quot;&#39;</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="n">sql_to_df</span><span class="p">(</span><span class="n">query_field_alias</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>


<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>profit</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>227.24</td>
    </tr>
    <tr>
      <th>1</th>
      <td>567.27</td>
    </tr>
    <tr>
      <th>2</th>
      <td>7098.15</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1407.78</td>
    </tr>
    <tr>
      <th>4</th>
      <td>14745.24</td>
    </tr>
  </tbody>
</table>
</div>

<h4>Now, you know some basic classes in PyPika. I highly recommend you try to use PyPika because it excels at all sorts of SQL queries but is expecially useful for data analysis.</h4>
<p><img alt="png" src="images/life-changes.png"></p>	

	</article>

    <p>
	<a href="https://twitter.com/share" class="twitter-share-button" data-via="" data-lang="en" data-size="large" data-related="">Tweet</a>
	<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
	</p>


		  </div>

		  <div class="sidebar">

	        <nav>
	          <h2>Categories</h2>
	          <ul>
	              <li ><a href=" https://lucashomil.github.io/datascience/category/python.html">Python</a></li>
	              <li class="active"><a href=" https://lucashomil.github.io/datascience/category/sql.html">SQL</a></li>
	          </ul>
	        </nav>

	          <aside>
	          <h2>Social</h2>
			    <ul class="social">
				  <li><a href="https://github.com/lucashomil">Github</a><i></i></li>
				  <li><a href="https://www.linkedin.com/in/lucas-ho-93b5ba9b/">Linkedin</a><i></i></li>
			    </ul>
			  </aside>


		  </div>

	  </div>

      <footer>
		<p role="contentinfo">
		  Â© 2019 Lucas Ho - Proudly powered by <a href="http://alexis.notmyidea.org/pelican/"></a>pelican-simplegrey</a>.
    </p>

	  </footer>

	</div>


</body>
</html>